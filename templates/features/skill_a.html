{% extends "base.html" %}

{% block title %}Skill A - Habilidade de Ler Instagram{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">Análise de Perfil do Instagram</h1>
            <p class="lead mb-4">
                Faça upload dos prints do seu perfil do Instagram para receber uma análise arquetípica detalhada.
            </p>

            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category if category != 'message' else 'info' }}">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-3">Instruções</h5>
                    <p>Faça upload de 3 capturas de tela do seu perfil do Instagram:</p>
                    <ol>
                        <li>Print da sua Bio do Instagram</li>
                        <li>Print do seu perfil do Instagram</li>
                        <li>Print do feed de suas fotos e vídeos</li>
                    </ol>
                    <p class="text-muted">Todos os arquivos devem estar no formato .jpg, .jpeg ou .png e ter menos de 5MB cada. <strong>Tamanho máximo total: 15MB.</strong></p>
                </div>
            </div>

            <form method="POST" enctype="multipart/form-data" id="instagram-analysis-form">
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">1. Bio do Instagram</h5>
                                <div class="mb-3">
                                    <input type="file" class="form-control" id="bio_image" name="bio_image" accept="image/jpeg,image/png" required>
                                    <div class="form-text">Tamanho máximo: 5MB</div>
                                </div>
                                <div class="image-preview mt-3" id="bio_image_preview"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">2. Perfil do Instagram</h5>
                                <div class="mb-3">
                                    <input type="file" class="form-control" id="profile_image" name="profile_image" accept="image/jpeg,image/png" required>
                                    <div class="form-text">Tamanho máximo: 5MB</div>
                                </div>
                                <div class="image-preview mt-3" id="profile_image_preview"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">3. Feed do Instagram</h5>
                                <div class="mb-3">
                                    <input type="file" class="form-control" id="feed_image" name="feed_image" accept="image/jpeg,image/png" required>
                                    <div class="form-text">Tamanho máximo: 5MB</div>
                                </div>
                                <div class="image-preview mt-3" id="feed_image_preview"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-grid gap-2 col-md-6 mx-auto mb-5">
                    <button type="submit" class="btn btn-primary btn-lg" id="analyze-button">
                        <i class="fas fa-search"></i> Analisar Perfil
                    </button>
                </div>
            </form>

            <div id="analysis-results" class="mt-5 d-none">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h3 class="mb-0">Resultado da Análise</h3>
                    </div>
                    <div class="card-body">
                        <div class="loading text-center d-none">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                            <p class="mt-3">Analisando seu perfil. Isso pode levar alguns instantes...</p>
                        </div>
                        <div id="analysis-content"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Função para mostrar preview da imagem
    function previewImage(input, previewId) {
        const preview = document.getElementById(previewId);
        preview.innerHTML = '';

        if (input.files && input.files[0]) {
            const file = input.files[0];
            
            // Verificar tamanho do arquivo (5MB limite)
            if (file.size > 5 * 1024 * 1024) {
                alert('O arquivo é muito grande! Por favor, selecione uma imagem menor que 5MB.');
                input.value = '';
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'img-fluid';
                preview.appendChild(img);
            }
            
            reader.readAsDataURL(file);
        }
    }

    // Configurar preview para cada upload de imagem
    document.getElementById('bio_image').addEventListener('change', function() {
        previewImage(this, 'bio_image_preview');
    });
    
    document.getElementById('profile_image').addEventListener('change', function() {
        previewImage(this, 'profile_image_preview');
    });
    
    document.getElementById('feed_image').addEventListener('change', function() {
        previewImage(this, 'feed_image_preview');
    });

    // Manipular envio do formulário
    const form = document.getElementById('instagram-analysis-form');
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Verificar tamanhos dos arquivos antes de enviar
        const bioImage = document.getElementById('bio_image').files[0];
        const profileImage = document.getElementById('profile_image').files[0];
        const feedImage = document.getElementById('feed_image').files[0];
        
        if (!bioImage || !profileImage || !feedImage) {
            alert('Por favor, selecione todas as três imagens.');
            return;
        }
        
        // Verificar tamanho dos arquivos individualmente
        if (bioImage.size > 5 * 1024 * 1024 || 
            profileImage.size > 5 * 1024 * 1024 || 
            feedImage.size > 5 * 1024 * 1024) {
            alert('Um ou mais arquivos excedem o limite de 5MB. Por favor, comprima as imagens ou selecione arquivos menores.');
            return;
        }
        
        // Verificar tamanho total
        const totalSize = bioImage.size + profileImage.size + feedImage.size;
        if (totalSize > 15 * 1024 * 1024) {
            alert('O tamanho total das imagens excede 15MB. Por favor, comprima as imagens ou selecione arquivos menores.');
            return;
        }
        
        // Mostrar a área de resultados com o loader
        const resultsArea = document.getElementById('analysis-results');
        resultsArea.classList.remove('d-none');
        
        const loadingIndicator = resultsArea.querySelector('.loading');
        loadingIndicator.classList.remove('d-none');
        
        const analysisContent = document.getElementById('analysis-content');
        analysisContent.innerHTML = '';
        
        // Preparar os dados para envio
        const formData = new FormData(form);
        
        // Enviar requisição AJAX
        fetch('{{ url_for("main.analyze_instagram") }}', {
            method: 'POST',
            body: formData,
            credentials: 'same-origin'
        })
        .then(response => {
            if (!response.ok) {
                if (response.status === 413) {
                    throw new Error('Arquivos muito grandes! O tamanho total das imagens excede o limite permitido.');
                }
                throw new Error('Erro na requisição: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            // Esconder o loading
            loadingIndicator.classList.add('d-none');
            
            // Mostrar os resultados
            if (data.success) {
                analysisContent.innerHTML = `
                    <div class="analysis-report">
                        ${data.analysis}
                    </div>
                `;
            } else {
                analysisContent.innerHTML = `
                    <div class="alert alert-danger">
                        <h4 class="alert-heading">Erro!</h4>
                        <p>${data.error}</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            // Esconder o loading
            loadingIndicator.classList.add('d-none');
            
            // Mostrar mensagem de erro
            analysisContent.innerHTML = `
                <div class="alert alert-danger">
                    <h4 class="alert-heading">Erro!</h4>
                    <p>Ocorreu um erro ao processar sua solicitação: ${error.message}</p>
                </div>
            `;
        });
    });
});
</script>

<style>
.image-preview {
    min-height: 150px;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    padding: 0.5rem;
    background-color: #f8f9fa;
}

.analysis-report {
    white-space: pre-line;
}
</style>
{% endblock %}
